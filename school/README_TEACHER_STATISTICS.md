# Обновление статистики преподавателей

## Описание

Система динамически вычисляет статистику преподавателей на основе оценок студентов из групп, которые ведет преподаватель. Статистика вычисляется при каждом просмотре личного кабинета преподавателя.

## Показатели статистики

1. **Средняя успеваемость** - средний балл за уроки студентов из групп преподавателя
2. **Средняя посещаемость** - процент присутствующих на уроках студентов
3. **Средняя за экзамены** - средний балл за домашние задания студентов

## Источники данных

- **Оценки за уроки**: таблица `statistics` (поле `grade_lesson`)
- **Посещаемость**: таблица `statistics` (наличие оценки > 0 означает присутствие)
- **Оценки за экзамены**: таблица `home_work_students` (поле `grade`)

## Динамическое вычисление

### При просмотре личного кабинета
Статистика автоматически вычисляется при каждом просмотре личного кабинета преподавателя через метод `getStatistics()` в модели `Teacher`.

### Ручное обновление (опционально)
Для обновления статистики всех преподавателей в базе данных:
```bash
php artisan teachers:update-statistics
```

Для обновления статистики конкретного преподавателя:
```bash
php artisan teachers:update-statistics --teacher-id=1
```

## API для получения статистики

### Получение статистики преподавателя
```
GET /teacher/statistics
```

**Ответ:**
```json
{
    "success": true,
    "data": {
        "average_performance": 4.2,
        "average_attendance": 85.5,
        "average_exam_score": 4.1
    }
}
```

## Логика вычисления

### Алгоритм расчета статистики

1. **Находим курсы преподавателя:**
   - Ищем в таблице `courses` записи, где `access_->teachers` содержит ID преподавателя

2. **Находим группы преподавателя:**
   - Ищем в таблице `groups` записи, где `courses` содержит хотя бы один из найденных курсов

3. **Находим студентов:**
   - Ищем в таблице `students` записи, где `group_name` соответствует найденным группам

4. **Вычисляем показатели:**
   - **Средняя успеваемость**: среднее значение `grade_lesson` из таблицы `statistics` для найденных студентов (только где `grade_lesson > 0`)
   - **Средняя посещаемость**: процент записей с `grade_lesson > 0` от всех записей для найденных студентов
   - **Средняя за экзамены**: среднее значение `grade` из таблицы `home_work_students` для найденных студентов (только где `grade > 0`)

### Пример SQL-запросов

```sql
-- Находим курсы преподавателя
SELECT id FROM courses 
WHERE JSON_CONTAINS(access_->teachers, '1') 
   OR JSON_CONTAINS(access_->teachers, '"1"');

-- Находим группы преподавателя
SELECT name FROM groups 
WHERE JSON_CONTAINS(courses, '1') 
   OR JSON_CONTAINS(courses, '"1"');

-- Находим студентов
SELECT id FROM students 
WHERE group_name IN ('Группа 1', 'Группа 2');

-- Вычисляем среднюю успеваемость
SELECT AVG(grade_lesson) as avg_performance 
FROM statistics 
WHERE student_id IN (1, 2, 3) 
  AND grade_lesson > 0;
```

## Файлы системы

- **Модель**: `app/Models/Teacher.php` - методы `getStatistics()` и `calculateAndUpdateStatistics()`
- **Контроллер**: `app/Http/Controllers/TeacherController.php` - метод `account()`
- **Представление**: `resources/views/teacher/account.blade.php`
- **Команда**: `app/Console/Commands/UpdateTeacherStatistics.php`
- **Job**: `app/Jobs/UpdateTeacherStatisticsJob.php`

## Примечания

- Статистика вычисляется динамически при каждом просмотре личного кабинета
- Значения в таблице `teachers` (поля `average_performance`, `average_attendance`, `average_exam_score`) не используются для отображения
- Для оптимизации производительности можно добавить кэширование результатов 