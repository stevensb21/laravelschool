# Исправление проблемы с доступом к файлам методики

## Проблема
Преподаватели и студенты не могут открыть файлы методики, хотя администратор может их загружать и просматривать. Ошибка: "Failed to load resource: the server responded with a status of 404 (Not Found)".

## Причины проблемы

### 1. Отсутствие символической ссылки storage
Laravel требует символическую ссылку от `public/storage` к `storage/app/public` для доступа к файлам через веб-сервер.

### 2. Неправильная проверка доступа к файлам
Маршрут `/storage/{path}` не проверяет права доступа пользователей к конкретным файлам методики.

### 3. Проблемы с правами доступа к курсам
Система не корректно проверяет, имеет ли преподаватель или студент доступ к курсу, к которому привязан файл.

## Решение

### Шаг 1: Создание символической ссылки

#### Для Windows:
```bash
# Запустите как администратор
cd school
mklink /D "public\storage" "storage\app\public"
```

Или используйте созданный batch файл:
```bash
create_storage_link.bat
```

#### Для Linux/Mac:
```bash
cd school
php artisan storage:link
```

### Шаг 2: Проверка структуры папок

Убедитесь, что существует папка:
```
school/storage/app/public/methodfile/
```

И в ней есть подпапки:
- homework/
- lesson/
- exercise/
- book/
- presentation/
- test/
- article/

### Шаг 3: Проверка прав доступа

Убедитесь, что веб-сервер имеет права на чтение файлов:
```bash
chmod -R 755 storage/app/public/methodfile/
```

### Шаг 4: Диагностика

Запустите скрипт диагностики:
```bash
php debug_file_access.php
```

Этот скрипт покажет:
- Существование папок и файлов
- Настройки символической ссылки
- Файлы методики в базе данных
- Доступ преподавателей к курсам
- Группы студентов и их курсы

### Шаг 5: Проверка настроек курсов

Убедитесь, что в таблице `courses` поле `access_` содержит правильные данные:

```json
{
  "groups": [],
  "teachers": ["1", "2", "3"]
}
```

### Шаг 6: Проверка привязки групп к курсам

Убедитесь, что группы студентов привязаны к курсам через таблицу `course_group`.

## Альтернативное решение

Если проблема остается, используйте новый маршрут `/methodfile/{path}`, который:

1. Имеет более простую логику проверки доступа
2. Логирует все запросы для диагностики
3. Проверяет права доступа на основе роли пользователя

## Тестирование

1. Войдите как администратор и загрузите файл методики
2. Войдите как преподаватель и попробуйте открыть файл
3. Войдите как студент и попробуйте открыть файл
4. Проверьте логи Laravel для диагностики ошибок

## Логи

Проверьте логи Laravel для диагностики:
```bash
tail -f storage/logs/laravel.log
```

Ищите записи:
- "File access request"
- "Method file access request"
- "Access denied to method file"

## Дополнительные проверки

1. **Проверьте URL файлов**: Убедитесь, что в базе данных пути к файлам начинаются с `/storage/methodfile/`

2. **Проверьте MIME-типы**: Убедитесь, что файлы имеют правильные расширения

3. **Проверьте размер файлов**: Убедитесь, что файлы не пустые

4. **Проверьте кодировку**: Убедитесь, что имена файлов не содержат специальных символов

## Если проблема остается

1. Проверьте настройки веб-сервера (Apache/Nginx)
2. Убедитесь, что mod_rewrite включен (для Apache)
3. Проверьте права доступа к папке проекта
4. Проверьте настройки PHP (fileinfo extension) 