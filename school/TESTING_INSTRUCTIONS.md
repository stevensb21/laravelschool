# Инструкции для тестирования доступа к файлам

## Что было исправлено

1. **Упрощена логика проверки прав доступа** в маршруте `/storage/{path}`
2. **Добавлен простой тестовый маршрут** `/test-file/{filename}`
3. **Временно разрешен доступ** всем аутентифицированным пользователям к файлам методики

## Тестирование

### Шаг 1: Проверьте логи Laravel

```bash
tail -f storage/logs/laravel.log
```

### Шаг 2: Тестирование через браузер

1. **Войдите как администратор** и попробуйте открыть файл методики
2. **Войдите как преподаватель** (например, Иванникова Серафима Михайловна, ID: 6) и попробуйте открыть файл методики
3. **Войдите как студент** и попробуйте открыть файл методики

### Шаг 3: Тестирование через curl

```bash
# Тест как администратор
curl -I "http://your-domain.com/storage/methodfile/presentation/1756127572_68ac6154c71aa.pdf"

# Тест как преподаватель (замените на реальные данные сессии)
curl -I -H "Cookie: laravel_session=YOUR_SESSION_ID" "http://your-domain.com/storage/methodfile/presentation/1756127572_68ac6154c71aa.pdf"

# Тест через новый маршрут
curl -I "http://your-domain.com/test-file/presentation/1756127572_68ac6154c71aa.pdf"
```

### Шаг 4: Проверка через новый тестовый маршрут

Откройте в браузере:
```
http://your-domain.com/test-file/presentation/1756127572_68ac6154c71aa.pdf
```

Этот маршрут должен работать для всех аутентифицированных пользователей.

## Ожидаемые результаты

### ✅ Должно работать:
- Администраторы: доступ ко всем файлам
- Преподаватели: доступ к файлам методики
- Студенты: доступ к файлам методики

### ❌ Не должно работать:
- Неаутентифицированные пользователи: ошибка 401
- Доступ к файлам вне папки methodfile: ошибка 403 (кроме администраторов)

## Если проблема остается

1. **Проверьте логи Nginx**:
```bash
sudo tail -f /var/log/nginx/error.log
```

2. **Проверьте логи Laravel**:
```bash
tail -f storage/logs/laravel.log
```

3. **Проверьте права доступа**:
```bash
ls -la storage/app/public/methodfile/
ls -la public/storage/
```

4. **Перезапустите Nginx**:
```bash
sudo systemctl reload nginx
```

## Следующие шаги

После того как базовая функциональность заработает, можно будет добавить более детальную проверку прав доступа:

1. Проверка доступа преподавателя к конкретному курсу
2. Проверка доступа студента к курсам своей группы
3. Логирование всех попыток доступа к файлам

## Временное решение

Если ничего не помогает, можно временно отключить проверку прав доступа полностью:

```php
// В маршруте /storage/{path} закомментируйте все проверки
if (file_exists($filePath) && is_file($filePath)) {
    $mimeType = mime_content_type($filePath);
    return response()->file($filePath, [
        'Content-Type' => $mimeType,
        'Content-Disposition' => 'inline; filename="' . basename($filePath) . '"'
    ]);
}
``` 